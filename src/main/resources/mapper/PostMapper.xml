<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uav.ops.mapper.PostMapper">

    <select id="listPost" resultType="com.uav.ops.dto.res.PostResDTO">
        select p.id, p.org_id, d.org_name, p.post_name, p.status, p.create_date
        from sys_post as p left join sys_dept as d on d.id=p.org_id and d.is_delete=0
        where p.is_delete=0
        <if test="status!=null">
            and p.status=#{status}
        </if>
        <if test="name!=null and name!=''">
            and p.post_name like CONCAT('%',#{name},'%')
        </if>
        order by p.create_date desc
    </select>

    <select id="listAllPost" resultType="com.uav.ops.dto.res.PostResDTO">
        select p.id, p.org_id, d.org_name, p.post_name, p.status, p.create_date
        from sys_post as p left join sys_dept as d on d.id=p.org_id and d.is_delete=0
        where p.is_delete=0 and p.status=0
        order by p.create_date desc
    </select>

    <update id="modifyPost">
        update sys_post set
        <if test="orgId!=null and orgId!=''">
            org_id=#{orgId},
        </if>
        <if test="postName!=null and postName!=''">
            post_name=#{postName},
        </if>
        <if test="status!=null">
            status=#{status},
        </if>
        update_by=#{userId}, update_date=now()
        where
        id=#{id} and is_delete=0
    </update>

    <insert id="addPost">
        INSERT INTO sys_post (id, org_id, post_name, status, create_by)
        value (#{id}, #{orgId}, #{postName}, #{status}, #{userId})
    </insert>

    <update id="deletePost">
        update sys_post set
        is_delete=1, update_by=#{userId}, update_date=now()
        where id=#{id} and is_delete=0;
        delete from sys_user_post where post_id=#{id};
    </update>

    <delete id="bindingPost">
        delete from sys_user_post where post_id=#{postId};
        INSERT INTO sys_user_post (id, user_id, post_id) values
        <foreach collection="userIds" index="index" item="userId" separator=",">
            (replace(uuid(),"-",""), #{userId}, #{postId})
        </foreach>
        ;
    </delete>

    <insert id="insertPost" parameterType="com.uav.ops.dto.res.VxUserResDTO">
        TRUNCATE TABLE sys_post;
        <foreach collection="list" index="index" item="user" separator="">
            <if test="user.department!=null and user.department.size()>0">
                <foreach collection="user.department" index="index" item="dept" separator=";">
                    INSERT INTO sys_post (id, org_id, post_name, create_by)
                    SELECT replace(uuid(),"-",""), #{dept}, #{user.position}, #{doName}
                    FROM DUAL
                    WHERE not exists (SELECT id FROM sys_post WHERE org_id=#{dept} and post_name=#{user.position})
                </foreach>
            </if>
        </foreach>
        ;
    </insert>

    <insert id="insertUserPost" parameterType="com.uav.ops.dto.res.VxUserResDTO">
        TRUNCATE TABLE sys_user_post;
        INSERT INTO sys_user_post (id, user_id, post_id) values
        <foreach collection="list" index="index" item="user" separator="">
            <if test="user.department!=null and user.department.size()>0">
                <foreach collection="user.department" index="index" item="dept" separator=",">
                    (replace(uuid(),"-",""), #{user.userid}, (select id from sys_post where org_id=#{dept} and post_name=#{user.position} and is_delete=0 and status=0))
                </foreach>
            </if>
        </foreach>
        ;
    </insert>

    <insert id="addPostChangeWarn">
        insert into t_post_change_warning(id, user_id, info, ring_time, files, old_post_id, new_post_id)
        value (replace(uuid(),"-",""), #{userId},
        CONCAT((select real_name from sys_user_ext where user_id=#{userId} and status=0 and is_delete=0),"从",
        (select p.post_name from sys_user_post as up left join sys_post as p on p.id=up.post_id and p.status=0 and p.is_delete=0
        where up.id=#{id}),"岗位变更,需要更新其危害因素关联信息"), now(), #{files},
        (select p.id from sys_user_post as up left join sys_post as p on p.id=up.post_id and p.status=0 and p.is_delete=0
        where up.id=#{id}), #{postId})
    </insert>

    <select id="listPostWarn" resultType="com.uav.ops.dto.res.PostWarnResDTO">
        select id, user_id, status, info, ring_time from t_post_change_warning
        where is_delete=0
        order by create_date desc
    </select>

    <update id="handlePostWarn">
        update t_post_change_warning set status=1 where id=#{id} and is_delete=0
    </update>
</mapper>