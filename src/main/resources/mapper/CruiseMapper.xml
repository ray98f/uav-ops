<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uav.ops.mapper.CruiseMapper">

    <select id="listCruiseLine" resultType="com.uav.ops.dto.res.CruiseLineResDTO">
        select cl.id, cl.line_name, cl.mileage, cl.fly_height, cl.fly_speed, cl.estimated_time, cl.status,
        cl.remark, cl.create_date, case when count(cp.id) is null then 0 else count(cp.id) end as point_count
        from t_cruise_line as cl left join t_cruise_point as cp on cp.line_id=cl.id and cp.status=0 and cp.is_delete=0
        where cl.is_delete=0
        <if test="name!=null and name!=''">
            and cl.line_name like concat('%', #{name}, '%')
        </if>
        group by cl.id
        order by cl.create_date desc
    </select>

    <select id="getCruiseLineDetail" resultType="com.uav.ops.dto.res.CruiseLineResDTO">
        select cl.id, cl.line_name, cl.mileage, cl.fly_height, cl.fly_speed, cl.estimated_time, cl.status,
        cl.remark, cl.create_date, case when count(cp.id) is null then 0 else count(cp.id) end as point_count
        from t_cruise_line as cl left join t_cruise_point as cp on cp.line_id=cl.id and cp.status=0 and cp.is_delete=0
        where cl.is_delete=0 and cl.id=#{id}
        group by cl.id
    </select>

    <select id="selectCruiseLineIsExist" resultType="java.lang.Integer">
        select count(1) from t_cruise_line
        where line_name=#{lineName}
        <if test="id!=null and id!=''">
            and id!=#{id}
        </if>
        limit 1
    </select>

    <insert id="addCruiseLine">
        insert into t_cruise_line(id, line_name, mileage, fly_height, fly_speed, estimated_time, status, remark, create_by)
        value (#{id}, #{lineName}, #{mileage}, #{flyHeight}, #{flySpeed}, #{estimatedTime}, #{status}, #{remark}, #{userId})
    </insert>

    <update id="modifyCruiseLine">
        update t_cruise_line set
        <if test="lineName!=null">
            line_name=#{lineName},
        </if>
        <if test="mileage!=null">
            mileage=#{mileage},
        </if>
        <if test="flyHeight!=null">
            fly_height=#{flyHeight},
        </if>
        <if test="flySpeed!=null">
            fly_speed=#{flySpeed},
        </if>
        <if test="estimatedTime!=null">
            estimated_time=#{estimatedTime},
        </if>
        <if test="status!=null">
            status=#{status},
        </if>
        <if test="remark!=null">
            remark=#{remark},
        </if>
        update_by=#{userId}
        where id=#{id} and is_delete=0
    </update>

    <update id="deleteCruiseLine">
        update t_cruise_line set
        is_delete=1, update_by=#{userId}
        where id=#{id} and is_delete=0;
        update t_cruise_point set
        is_delete=1, update_by=#{userId}
        where line_id=#{id} and is_delete=0;
    </update>

    <select id="listCruisePoint" resultType="com.uav.ops.dto.res.CruisePointResDTO">
        select id, point_name, line_id, lng, lat, point_height, point_speed, sort, status, remark, action_type, create_date
        from t_cruise_point
        where is_delete=0 and line_id=#{lineId}
        <if test="name!=null and name!=''">
            and point_name like concat('%', #{name}, '%')
        </if>
        order by create_date desc
    </select>

    <select id="getCruisePointDetail" resultType="com.uav.ops.dto.res.CruisePointResDTO">
        select id, point_name, line_id, lng, lat, point_height, point_speed, sort, status, remark, action_type, create_date
        from t_cruise_point
        where is_delete=0 and id=#{id}
    </select>

    <select id="selectCruisePointIsExist" resultType="java.lang.Integer">
        select count(1) from t_cruise_point
        where point_name=#{pointName} and line_id=#{lineId}
        <if test="id!=null and id!=''">
            and id!=#{id}
        </if>
        limit 1
    </select>

    <insert id="addCruisePoint">
        insert into t_cruise_point(id, point_name, line_id, lng, lat, point_height, point_speed,
        sort, status, remark, action_type, create_by) value
        (#{id}, #{pointName}, #{lineId}, #{lng}, #{lat}, #{pointHeight}, #{pointSpeed},
        #{sort}, #{status}, #{remark}, #{actionType}, #{userId})
    </insert>

    <update id="modifyCruiseLine">
        update t_cruise_point set
        <if test="pointName!=null">
            point_name=#{pointName},
        </if>
        <if test="lineId!=null">
            line_id=#{lineId},
        </if>
        <if test="lng!=null">
            lng=#{lng},
        </if>
        <if test="lat!=null">
            lat=#{lat},
        </if>
        <if test="pointHeight!=null">
            point_height=#{pointHeight},
        </if>
        <if test="pointSpeed!=null">
            point_speed=#{pointSpeed},
        </if>
        <if test="sort!=null">
            sort=#{sort},
        </if>
        <if test="status!=null">
            status=#{status},
        </if>
        <if test="remark!=null">
            remark=#{remark},
        </if>
        <if test="actionType!=null">
            action_type=#{actionType},
        </if>
        update_by=#{userId}
        where id=#{id} and is_delete=0
    </update>

    <update id="deleteCruiseLine">
        update t_cruise_point set
        is_delete=1, update_by=#{userId}
        where id=#{id} and is_delete=0
    </update>
</mapper>